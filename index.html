<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <title>COVID-19</title>
    <meta name="viewport" content="width=device-width" />
    <style>
      body {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        background-color: #fffaf7;
        line-height: 1.3;
      }
      main {
        max-width: 90ch;
        padding: 2ch;
        margin: auto;
      }
      a {
        color: #0072bb;
        text-decoration: none;
        outline: 0;
      }
      h1 {
        margin-bottom: 0.5rem;
        font-size: 3rem;
        letter-spacing: 0.2rem;
        text-align: center;
        color: #0072bb;
      }
      footer {
        margin-top: 2rem;
        text-align: center;
        font-size: 2rem;
      }

      footer p {
        font-size: 1rem;
        color: #888888;
      }

      .filter {
        display: flex;
        justify-content: space-between;
      }

      .align-left {
        display: inline-block;
        text-align: left;
      }
    </style>
  </head>
  <body>
    <main>
      <article>
        <header>
          <h1>Covid-19</h1>
        </header>
        <body>
          <div class="filter">
            <div id="datefilter">
              <label for="desde">Desde:</label>
              <input
                type="date"
                id="fechadesde"
                value="2017-06-01"
                name="desde"
              />
              <label for="hasta">Hasta:</label>
              <input
                type="date"
                id="fechahasta"
                value="2014-02-06"
                name="hasta"
              />
            </div>
            <div id="countryfilter">
              <select id="paises"> </select>
            </div>
          </div>
          <div id="chart"></div>

          <hr />
        </body>
        <footer>
          <p>
            InformaciÃ³n extraida de
            <a href="https://documenter.getpostman.com/view/10808728/SzS8rjbc?version=latest"
              >POSTMAN API Covid</a
            >
          </p>
          ðŸ¦ 
        </footer>
      </article>
    </main>
  </body>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script>
    async function getAsyncData(url) {
      let fetchData = await fetch(url, {
        method: "Get",
      });
      return fetchData.json();
    }

    Date.prototype.addHours = function (h) {
      this.setTime(this.getTime() + h * 60 * 60 * 1000);
      return this;
    };

    function formatearFecha(fecha, separador) {
      let date = new Date(fecha);
      let d = new Date(date.getTime() + date.getTimezoneOffset() * 60000)
   
      let month = "" + (d.getMonth() + 1),
        day = "" + d.getDate(),
        year = d.getFullYear();

      if (month.length < 2) month = "0" + month;
      if (day.length < 2) day = "0" + day;

      return [year, month, day].join(separador);
    }
    
    async function cargarPaises(selectorPaises, paisInicial) {
      let listaPaises = await getAsyncData(
        "https://api.covid19api.com/countries"
      );

      listaPaises
        .sort((a, b) => {
          if (a.Country > b.Country) {
            return -1;
          }
          if (b.Country > a.Country) {
            return 1;
          }
          return 0;
        })
        .reverse();

      listaPaises.forEach((pais) => {
        let paisElement = document.createElement("option");
        paisElement.value = pais.Slug;
        paisElement.innerHTML = pais.Country;
        selectorPaises.appendChild(paisElement);
      });

      if (paisInicial) {
        selectorPaises.value = paisInicial;
      }
    }

    function cargarFechas(inputDesde, inputHasta) {
      let dateDesde = new Date();
      dateDesde.setDate(dateDesde.getDate() - 7);
      inputDesde.value = formatearFecha(dateDesde, "-");
      inputHasta.min = formatearFecha(dateDesde, "-");

      let fechaHasta = formatearFecha(new Date(), "-");
      inputHasta.value = fechaHasta;
      inputDesde.max = fechaHasta;
      inputHasta.max = fechaHasta;
    }

    function renderGrafico(pais, dataCasos, dataDecesos, dataRecuperados) {
      document.querySelector("#chart").innerHTML = "";

      var options = {
        colors: ["#FC5D19", "#FF0000", "#00DD00"],
        xaxis: {
          position: "bottom",
          axisBorder: {
            show: false,
          },
          axisTicks: {
            show: false,
          },
          tooltip: {
            enabled: true,
          },
        },
        series: [
          {
            name: "Casos",
            data: dataCasos,
          },
          {
            name: "Decesos",
            data: dataDecesos,
          },
          {
            name: "Recuperados",
            data: dataRecuperados,
          },
        ],
        chart: {
          height: 400,
          type: "line",
          zoom: {
            enabled: false,
          },
        },
        plotOptions: {
          line: {
            dataLabels: {
              position: "bottom",
            },
          },
        },
        dataLabels: {
          enabled: true,
          offsetY: -10,
          style: {
            fontSize: "12px",
          },
        },
        yaxis: {
          axisBorder: {
            show: false,
          },
          axisTicks: {
            show: false,
          },
          labels: {
            show: false,
          },
        },
        title: {
          text: `Covid-19 ${pais}, 2020`,
          floating: true,
          offsetY: 10,
          align: "center",
          style: {
            color: "#000000",
          },
        },
      };

      var chart = new ApexCharts(document.querySelector("#chart"), options);
      chart.render();
    }

    async function cargarArrayDatos(pais, tipo, fechaDesde, fechaHasta) {
      const url = `https://api.covid19api.com/total/country/${pais}/status/${tipo}`;
      let rawData = await getAsyncData(url);
      
      let returnValue = rawData
        .filter((x) => x.Date >= fechaDesde && x.Date <= fechaHasta)
        .map((x) => {
          const dayData = {};      
          dayData.x = formatearFecha(x.Date, "/");      
          dayData.y = x.Cases;
          return dayData;
        });
      return returnValue;
    }

    async function cargarGrafico(pais, nombrePais, fechaDesde, fechaHasta) {
      let dataCasos = await cargarArrayDatos(
        pais,
        "confirmed",
        fechaDesde,
        fechaHasta
      );
      let dataRecuperados = await cargarArrayDatos(
        pais,
        "recovered",
        fechaDesde,
        fechaHasta
      );
      let dataDecesos = await cargarArrayDatos(
        pais,
        "deaths",
        fechaDesde,
        fechaHasta
      );

      renderGrafico(nombrePais, dataCasos, dataDecesos, dataRecuperados);
    }

    window.onload = function () {
      let pais = "argentina"; //Default
      let nombrePais = "argentina";
      const paisSelector = document.getElementById("paises");
      const fechaDesdeInput = document.getElementById("fechadesde");
      const fechaHastaInput = document.getElementById("fechahasta");

      cargarPaises(paisSelector, pais);
      cargarFechas(fechaDesdeInput, fechaHastaInput);

      //En el caso de que cambie, llevarlo a los cambios
      let indicePais = paisSelector.selectedIndex;
      if (indicePais >= 0) {
        pais = paisSelector.options[indicePais].value;
        nombrePais = paisSelector.options[indicePais].text;
      }

      let fechaDesde = new Date(fechaDesdeInput.value).toISOString();
      let fechaHasta = new Date(fechaHastaInput.value).toISOString();

      cargarGrafico(pais, nombrePais, fechaDesde, fechaHasta);

      //EventListeners
      paisSelector.addEventListener("change", function () {
        indicePais = paisSelector.selectedIndex;
        if (indicePais >= 0) {
          pais = paisSelector.options[indicePais].value;
          nombrePais = paisSelector.options[indicePais].text;
        }
        fechaDesde = new Date(fechaDesdeInput.value).toISOString();
        fechaHasta = new Date(fechaHastaInput.value).toISOString();
        cargarGrafico(pais, nombrePais, fechaDesde, fechaHasta);
      });

      let oldDateDesde = fechaDesdeInput.value;
      let isChangedDesde = function () {
        if (fechaDesdeInput.value !== oldDateDesde) {
          oldDateDesde = fechaDesdeInput.value;
          fechaHastaInput.min = fechaDesdeInput.value;
          return true;
        }
        return false;
      };
      fechaDesdeInput.addEventListener("change", function () {
        if (isChangedDesde()) {
          if (new Date(this.value) > new Date(fechaHastaInput.value)) {
            this.value = oldDateDesde;
            this.innerText = oldDateDesde;
          } else {
            fechaDesde = new Date(fechaDesdeInput.value).toISOString();
            fechaHasta = new Date(fechaHastaInput.value).toISOString();
            cargarGrafico(pais, nombrePais, fechaDesde, fechaHasta);
          }
        }
      });

      let olddateHasta = fechaHastaInput.value;
      let isChangedHasta = function () {
        if (fechaHastaInput.value !== olddateHasta) {
          olddateHasta = fechaHastaInput.value;
          fechaDesdeInput.max = fechaHastaInput.value;
          return true;
        }
        return false;
      };
      fechaHastaInput.addEventListener("change", function () {
        if (isChangedHasta()) {
          if (new Date(this.value) < new Date(fechaDesdeInput.value)) {
            this.value = oldDateHasta;
            this.innerText = oldDateHasta;
          } else {
            fechaDesde = new Date(fechaDesdeInput.value).toISOString();
            fechaHasta = new Date(fechaHastaInput.value).toISOString();
            cargarGrafico(pais, nombrePais, fechaDesde, fechaHasta);
          }
        }
      });
    };
  </script>
</html>
